name: ci

on:
  push:
  pull_request:

jobs:
  test-cli:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Lint (compile only)
        run: |
          python -m py_compile blackice/cli/main.py
          python -m py_compile blackice/simulator/cli.py
          python -m py_compile blackice/detections/engine.py
          python -m py_compile blackice/cli/validate.py

      - name: Run CLI (warn must pass)
        run: |
          python -m blackice run \
            --input data/samples/toy.jsonl \
            --outdir data/out \
            --audit-mode warn

      - name: Run CLI (strict must fail if changed)
        run: |
          set +e
          python -m blackice run \
            --input data/samples/toy.jsonl \
            --outdir data/out2 \
            --audit-mode strict
          code=$?
          echo "exit_code=$code"
          if [ "$code" -eq 0 ]; then
            echo "Expected strict mode to fail (non-zero) when normalization changes output"
            exit 1
          fi
          exit 0
